<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PicoCode - Local Codebase Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    body { padding-top: 1.5rem; padding-bottom: 3rem; background:#f7f9fb; }
    .chat-window { height: 62vh; overflow:auto; padding:.75rem; background:#ffffff; border:1px solid #e9ecef; border-radius:8px; }
    .msg { margin-bottom:.75rem; display:flex; gap:.75rem; }
    .msg.user { justify-content:flex-end; }
    .msg.assistant { justify-content:flex-start; }
    .msg .card { max-width:78%; border-radius:10px; box-shadow:none; }
    .msg.user .card { background:#e9f5ff; border:1px solid #cfeeff; }
    .msg.assistant .card { background:#f8f9fa; border:1px solid #e9ecef; }
    .meta { font-size:.80rem; color:#6c757d; }
    .actions { display:flex; gap:.25rem; align-items:center; }
    .spinner-small { width:1rem; height:1rem; border:2px solid rgba(0,0,0,0.12); border-top-color:#0d6efd; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .context-list { font-family:monospace; font-size:.85rem; color:#333; }
    .context-item { margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-left: 3px solid #0d6efd; border-radius: 4px; }
    .context-item-header { font-weight: bold; margin-bottom: 0.5rem; color: #0d6efd; }
    .context-item-content { font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; background: #ffffff; padding: 0.5rem; border-radius: 4px; max-height: 200px; overflow-y: auto; }
    .markdown-content { line-height: 1.6; }
    .markdown-content pre { background: #f6f8fa; padding: 1rem; border-radius: 6px; overflow-x: auto; }
    .markdown-content code { background: #f6f8fa; padding: 0.2em 0.4em; border-radius: 3px; font-size: 85%; }
    .markdown-content pre code { background: transparent; padding: 0; }
    .controls-area { display:flex; gap:.5rem; align-items:center; }
    .empty-state { height:62vh; display:flex; align-items:center; justify-content:center; color:#6c757d; }
    .btn-sm-icon { padding:.25rem .5rem; font-size:.85rem; }
    .progress-info { font-size: .95rem; color: #333; display:flex; align-items:center; gap: 0.5rem; }
    .project-item { cursor: pointer; }
    .project-item:hover { background-color: #f8f9fa; }
    .project-item.active { background-color: #e7f3ff; border-left: 3px solid #0d6efd; }
  </style>
</head>
<body>
  <div class="container">
    <header class="mb-4">
      <h1 class="h3">PicoCode â€” Local Codebase Assistant</h1>
      <p class="text-muted small">Project-based RAG for local codebases. Chat with your code using AI.</p>
    </header>

    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title" style="cursor: pointer;" onclick="toggleSection('configSection')">
              Configuration <span id="configToggle">â–¼</span>
            </h5>
            <div id="configSection">
              <p class="mb-1"><strong>Embedding:</strong> {{ config.get("embedding_model") or "not set" }}</p>
              <p class="mb-0"><strong>Coding:</strong> {{ config.get("coding_model") or "not set" }}</p>

              <form action="/index" method="post" class="mt-3">
                <button class="btn btn-primary w-100" type="submit">Index Configured Project</button>
              </form>
            </div>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <h5 class="card-title" style="cursor: pointer;" onclick="toggleSection('addProjectSection')">
              Add New Project <span id="addProjectToggle">â–¼</span>
            </h5>
            <div id="addProjectSection">
              <div class="mb-2">
                <label for="new_project_path" class="form-label">Project Path <em>(absolute path)</em></label>
                <input type="text" id="new_project_path" class="form-control form-control-sm" placeholder="/path/to/your/project">
              </div>
              <div class="mb-2">
                <label for="new_project_name" class="form-label">Project Name (optional)</label>
                <input type="text" id="new_project_name" class="form-control form-control-sm" placeholder="My Project">
              </div>
              <button id="createProjectBtn" class="btn btn-success w-100" type="button">Create & Index another Project</button>
            </div>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <h5 class="card-title">Projects</h5>
            {% if projects %}
              <ul class="list-group list-group-flush" id="projectsList">
                {% for p in projects %}
                  <li class="list-group-item d-flex justify-content-between align-items-start project-item" data-project-id="{{ p.id }}">
                    <div class="flex-grow-1">
                      <div class="fw-bold text-black">{{ p.name or p.path.split('/')[-1] }}</div>
                      <small class="text-muted">{{ p.path }}</small><br>
                      <small class="text-muted">
                        Status: <span class="badge bg-{{ 'success' if p.status=='ready' else ('warning' if p.status=='indexing' else 'secondary') }}" data-status="{{ p.status }}">{{ p.status }}</span>
                      </small>
                      <br>
                      <small class="text-muted indexing-info" style="display:none;">
                        Indexed: <span class="file-count">0</span>/<span class="total-files">?</span> files | <span class="embedding-count">0</span> chunks
                      </small>
                    </div>
                    <div class="d-flex gap-1">
                      <button type="button" class="btn btn-sm btn-outline-success continue-index-btn" data-project-id="{{ p.id }}" title="Continue indexing (incremental)">+</button>
                      <button type="button" class="btn btn-sm btn-outline-primary reindex-project-btn" data-project-id="{{ p.id }}" title="Re-index project (full)">âŸ³</button>
                      <button type="button" class="btn btn-sm btn-outline-danger delete-project-btn" data-project-id="{{ p.id }}" title="Delete project">Ã—</button>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small mb-0">No projects yet. Index a project to get started.</p>
            {% endif %}
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <h5 class="card-title">Query Settings</h5>
            <div class="mb-2">
              <label for="project_id" class="form-label">Project</label>
              <select id="project_id" class="form-select form-select-sm">
                {% for p in projects %}
                  <option value="{{ p.id }}">{{ p.name or p.path.split('/')[-1] }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <label for="top_k" class="form-label">RAG top_k</label>
              <input type="number" id="top_k" class="form-control form-control-sm" value="5" min="1" max="20">
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="use_rag" checked>
              <label class="form-check-label" for="use_rag">Use RAG (semantic search)</label>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Chat</h5>
            <div id="chatWindow" class="chat-window">
              <div class="empty-state">Start a conversation by typing a message below</div>
            </div>
            <div class="mt-3">
              <textarea id="userPrompt" class="form-control" rows="3" placeholder="Ask a question about your codebase..."></textarea>
              <div class="controls-area mt-2">
                <button id="sendBtn" class="btn btn-primary">Send</button>
                <button id="clearBtn" class="btn btn-outline-secondary">Clear History</button>
                <div id="loadingIndicator" style="display:none;" class="spinner-small"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      // Toggle section visibility
      window.toggleSection = function(sectionId) {
        const $section = $('#' + sectionId);
        const $toggle = $('#' + sectionId.replace('Section', 'Toggle'));
        
        if ($section.css('display') === 'none') {
          $section.show();
          $toggle.text('â–¼');
        } else {
          $section.hide();
          $toggle.text('â–¶');
        }
      };
      
      // Configure marked for markdown rendering
      marked.setOptions({
        highlight: function(code, lang) {
          if (lang && hljs.getLanguage(lang)) {
            try {
              return hljs.highlight(code, { language: lang }).value;
            } catch (err) {}
          }
          return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true
      });

      const $chatWindow = $('#chatWindow');
      const $userPrompt = $('#userPrompt');
      const $sendBtn = $('#sendBtn');
      const $clearBtn = $('#clearBtn');
      const $loadingIndicator = $('#loadingIndicator');
      
      let chatHistory = JSON.parse(localStorage.getItem("picocode_chat_history") || "[]");

      function renderMarkdown(text) {
        // Parse markdown and sanitize HTML
        const rawHtml = marked.parse(text);
        return DOMPurify.sanitize(rawHtml);
      }
      
      window.deleteMessage = function(idx) {
        if (confirm('Delete this message?')) {
          chatHistory.splice(idx, 1);
          localStorage.setItem("picocode_chat_history", JSON.stringify(chatHistory));
          renderChat();
        }
      };

      function renderChat() {
        if (chatHistory.length === 0) {
          $chatWindow.html('<div class="empty-state">Start a conversation by typing a message below</div>');
          return;
        }
        
        $chatWindow.empty();
        chatHistory.forEach((msg, idx) => {
          const $msgDiv = $('<div>').addClass(`msg ${msg.role}`);
          
          let content = `
            <div class="card">
              <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <strong>${msg.role === 'user' ? 'You' : 'PicoCode'}</strong>
                  <button onclick="deleteMessage(${idx})" class="btn btn-sm btn-outline-danger" style="padding: 2px 8px; font-size: 12px;">Ã—</button>
                </div>
          `;
          
          // Render message text as markdown for assistant, plain text for user
          if (msg.role === 'assistant') {
            content += `<div class="markdown-content">${renderMarkdown(msg.text)}</div>`;
          } else {
            content += `<div>${escapeHtml(msg.text)}</div>`;
          }
          
          if (msg.context && msg.context.length > 0) {
            content += '<div class="mt-3"><strong>Files Used:</strong></div>';
            content += '<div class="context-list">';
            msg.context.forEach(c => {
              content += `
                <div class="context-item">
                  <div class="context-item-header">
                    ðŸ“„ ${escapeHtml(c.path)} 
                    <span class="badge bg-primary">${c.score.toFixed(4)}</span>
                  </div>
                </div>
              `;
            });
            content += '</div>';
          }
          
          content += `
                <div class="meta mt-2">${msg.timestamp}</div>
              </div>
            </div>
          `;
          
          $msgDiv.html(content);
          $chatWindow.append($msgDiv);
        });
        
        $chatWindow.scrollTop($chatWindow.prop('scrollHeight'));
        
        // Apply syntax highlighting to any code blocks
        $chatWindow.find('pre code').each(function() {
          hljs.highlightElement(this);
        });
      }

      function escapeHtml(text) {
        return $('<div>').text(text).html();
      }

      function addMessage(role, text, context = []) {
        const timestamp = new Date().toLocaleTimeString();
        chatHistory.push({ role, text, context, timestamp });
        localStorage.setItem("picocode_chat_history", JSON.stringify(chatHistory));
        renderChat();
      }

      async function sendMessage() {
        const prompt = $userPrompt.val().trim();
        if (!prompt) return;
        
        const project_id = $('#project_id').val();
        if (!project_id) {
          alert("Please select a project or index one first.");
          return;
        }
        
        const use_rag = $('#use_rag').is(':checked');
        const top_k = parseInt($('#top_k').val()) || 5;
        
        addMessage("user", prompt);
        $userPrompt.val("");
        
        $sendBtn.prop('disabled', true);
        $loadingIndicator.show();
        
        try {
          const response = await fetch("/code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              prompt, 
              use_rag, 
              project_id,
              top_k 
            })
          });
          
          const data = await response.json();
          
          if (data.error) {
            addMessage("assistant", `Error: ${data.error}`);
          } else {
            addMessage("assistant", data.response, data.used_context || []);
          }
        } catch (err) {
          addMessage("assistant", `Error: ${err.message}`);
        } finally {
          $sendBtn.prop('disabled', false);
          $loadingIndicator.hide();
        }
      }

      $sendBtn.on('click', sendMessage);
      $userPrompt.on('keydown', function(e) {
        if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          sendMessage();
        }
      });

      $clearBtn.on('click', function() {
        if (confirm("Clear chat history?")) {
          chatHistory = [];
          localStorage.removeItem("picocode_chat_history");
          renderChat();
        }
      });

      // Handle creating new project
      $('#createProjectBtn').on('click', async function() {
        const projectPath = $('#new_project_path').val().trim();
        const projectName = $('#new_project_name').val().trim();
        
        if (!projectPath) {
          alert("Please enter a project path");
          return;
        }
        
        try {
          // First, create the project
          const createResponse = await fetch('/api/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              path: projectPath,
              name: projectName || null
            })
          });
          
          if (!createResponse.ok) {
            const data = await createResponse.json();
            alert(`Failed to create project: ${data.error || 'Unknown error'}`);
            return;
          }
          
          const project = await createResponse.json();
          const projectId = project.id;
          
          // Then, start indexing
          const indexResponse = await fetch('/api/projects/index', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              project_id: projectId,
              incremental: true
            })
          });
          
          if (indexResponse.ok) {
            alert(`Project created and indexing started!\nProject ID: ${projectId}`);
            // Clear form
            $('#new_project_path').val("");
            $('#new_project_name').val("");
            // Reload page to show new project
            window.location.reload();
          } else {
            const data = await indexResponse.json();
            alert(`Project created but indexing failed: ${data.error || 'Unknown error'}`);
            window.location.reload();
          }
        } catch (err) {
          alert(`Error: ${err.message}`);
        }
      });

      // Allow Enter key to create project
      $('#new_project_path').on('keydown', function(e) {
        if (e.key === "Enter") {
          e.preventDefault();
          $('#createProjectBtn').click();
        }
      });

      // Highlight selected project
      $('.project-item').on('click', function() {
        $('.project-item').removeClass('active');
        $(this).addClass('active');
        const pid = $(this).attr('data-project-id');
        $('#project_id').val(pid);
      });

      // Select first project by default
      const $firstProject = $('.project-item').first();
      if ($firstProject.length) {
        $firstProject.addClass('active');
      }

      // Poll for project status updates with detailed stats
      setInterval(async () => {
        try {
          const response = await fetch("/projects/status");
          const projects = await response.json();
          
          // Update project status badges and stats
          for (const p of projects) {
            const $item = $(`[data-project-id="${p.id}"]`);
            if ($item.length) {
              const $badge = $item.find('.badge');
              if ($badge.length) {
                $badge.attr('class', `badge bg-${p.status === 'ready' ? 'success' : p.status === 'indexing' ? 'warning' : 'secondary'}`);
                $badge.text(p.status);
              }
              
              // Fetch detailed stats for this project
              try {
                const detailResponse = await fetch(`/api/projects/${p.id}`);
                const details = await detailResponse.json();
                
                if (details.indexing_stats) {
                  const $indexingInfo = $item.find('.indexing-info');
                  const $fileCount = $item.find('.file-count');
                  const $totalFiles = $item.find('.total-files');
                  const $embeddingCount = $item.find('.embedding-count');
                  
                  if ($indexingInfo.length && $fileCount.length && $totalFiles.length && $embeddingCount.length) {
                    $fileCount.text(details.indexing_stats.file_count || 0);
                    $totalFiles.text(details.indexing_stats.total_files || '?');
                    $embeddingCount.text(details.indexing_stats.embedding_count || 0);
                    
                    // Show stats if project has been indexed
                    if (details.indexing_stats.file_count > 0 || details.indexing_stats.total_files > 0) {
                      $indexingInfo.show();
                    } else {
                      $indexingInfo.hide();
                    }
                  }
                }
              } catch (detailErr) {
                // Ignore errors fetching individual project details
              }
            }
          }
        } catch (err) {
          console.error("Error polling status:", err);
        }
      }, 10000); // Poll every 10 seconds to reduce server load

      // Handle project re-indexing
      $(document).on('click', '.continue-index-btn', async function(e) {
        const projectId = $(this).attr('data-project-id');
        
        if (!confirm('Continue indexing this project? This will only index new or modified files.')) {
          return;
        }
        
        try {
          const response = await fetch('/api/projects/index', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              project_id: projectId,
              incremental: true 
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            alert(`Incremental indexing started. Status: ${data.status}`);
            // Reload page to show updated status
            window.location.reload();
          } else {
            const data = await response.json();
            alert(`Failed to start indexing: ${data.error || 'Unknown error'}`);
          }
        } catch (err) {
          alert(`Error starting indexing: ${err.message}`);
        }
      });
      
      // Handle full re-indexing
      $(document).on('click', '.reindex-project-btn', async function(e) {
        const projectId = $(this).attr('data-project-id');
        
        if (!confirm('Re-index this project completely? This will re-process all files.')) {
          return;
        }
        
        try {
          const response = await fetch('/api/projects/index', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              project_id: projectId,
              incremental: false 
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            alert(`Full re-indexing started. Status: ${data.status}`);
            // Reload page to show updated status
            window.location.reload();
          } else {
            const data = await response.json();
            alert(`Failed to start re-indexing: ${data.error || 'Unknown error'}`);
          }
        } catch (err) {
          alert(`Error starting re-indexing: ${err.message}`);
        }
      });
      
      // Handle project deletion
      $(document).on('click', '.delete-project-btn', async function(e) {
        const projectId = $(this).attr('data-project-id');
        
        if (!confirm('Delete this project and its database?')) {
          return;
        }
        
        try {
          const response = await fetch(`/projects/${projectId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            // Reload page to show updated project list
            window.location.reload();
          } else {
            const data = await response.json();
            alert(`Failed to delete project: ${data.error || 'Unknown error'}`);
          }
        } catch (err) {
          alert(`Error deleting project: ${err.message}`);
        }
      });

      // Initial render
      renderChat();
    });
  </script>
</body>
</html>
