<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PicoCode - Local Codebase Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 1.5rem; padding-bottom: 3rem; background:#f7f9fb; }
    .chat-window { height: 62vh; overflow:auto; padding:.75rem; background:#ffffff; border:1px solid #e9ecef; border-radius:8px; }
    .msg { margin-bottom:.75rem; display:flex; gap:.75rem; }
    .msg.user { justify-content:flex-end; }
    .msg.assistant { justify-content:flex-start; }
    .msg .card { max-width:78%; border-radius:10px; box-shadow:none; }
    .msg.user .card { background:#e9f5ff; border:1px solid #cfeeff; }
    .msg.assistant .card { background:#f8f9fa; border:1px solid #e9ecef; }
    .meta { font-size:.80rem; color:#6c757d; }
    .actions { display:flex; gap:.25rem; align-items:center; }
    .spinner-small { width:1rem; height:1rem; border:2px solid rgba(0,0,0,0.12); border-top-color:#0d6efd; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .context-list { font-family:monospace; font-size:.85rem; color:#333; }
    .controls-area { display:flex; gap:.5rem; align-items:center; }
    .empty-state { height:62vh; display:flex; align-items:center; justify-content:center; color:#6c757d; }
    .btn-sm-icon { padding:.25rem .5rem; font-size:.85rem; }
    #indexProgress { margin-bottom: 0.75rem; min-height: 2rem; }
    .progress-info { font-size: .95rem; color: #333; display:flex; align-items:center; gap: 0.5rem; }
    .project-item { cursor: pointer; }
    .project-item:hover { background-color: #f8f9fa; }
    .project-item.active { background-color: #e7f3ff; border-left: 3px solid #0d6efd; }
  </style>
</head>
<body>
  <div class="container">
    <header class="mb-4">
      <h1 class="h3">PicoCode — Local Codebase Assistant</h1>
      <p class="text-muted small">Project-based RAG for local codebases. Chat with your code using AI.</p>
    </header>

    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Configuration</h5>
            <p class="mb-1"><strong>Host:</strong> {{ config.get("uvicorn_host", "127.0.0.1") }} <strong>Port:</strong> {{ config.get("uvicorn_port", 8000) }}</p>
            <p class="mb-1"><strong>Local path:</strong> {{ config.get("local_path") or "not set" }}</p>
            <p class="mb-1"><strong>Embedding:</strong> {{ config.get("embedding_model") or "not set" }}</p>
            <p class="mb-0"><strong>Coding:</strong> {{ config.get("coding_model") or "not set" }}</p>

            <form action="/index" method="post" class="mt-3">
              <button class="btn btn-primary w-100" type="submit">Index Configured Project</button>
            </form>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <h5 class="card-title">Projects</h5>
            <div id="indexProgress"></div>
            {% if projects %}
              <ul class="list-group list-group-flush" id="projectsList">
                {% for p in projects %}
                  <li class="list-group-item d-flex justify-content-between align-items-start project-item" data-project-id="{{ p.id }}">
                    <div class="flex-grow-1">
                      <div class="fw-bold">{{ p.name or p.path.split('/')[-1] }}</div>
                      <small class="text-muted">{{ p.path }}</small><br>
                      <small class="text-muted">
                        Status: <span class="badge bg-{{ 'success' if p.status=='ready' else ('warning' if p.status=='indexing' else 'secondary') }}" data-status="{{ p.status }}">{{ p.status }}</span>
                      </small>
                      <br>
                      <small class="text-muted indexing-info" style="display:none;">
                        Files: <span class="file-count">0</span> | Embeddings: <span class="embedding-count">0</span>
                      </small>
                    </div>
                    <div>
                      <form action="/projects/{{ p.id }}" method="post" style="display:inline;" onsubmit="return confirm('Delete this project and its database?');">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit" class="btn btn-sm btn-outline-danger">×</button>
                      </form>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted small mb-0">No projects yet. Index a project to get started.</p>
            {% endif %}
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <h5 class="card-title">Query Settings</h5>
            <div class="mb-2">
              <label for="project_id" class="form-label">Project</label>
              <select id="project_id" class="form-select form-select-sm">
                {% for p in projects %}
                  <option value="{{ p.id }}">{{ p.name or p.path.split('/')[-1] }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-2">
              <label for="top_k" class="form-label">RAG top_k</label>
              <input type="number" id="top_k" class="form-control form-control-sm" value="5" min="1" max="20">
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="use_rag" checked>
              <label class="form-check-label" for="use_rag">Use RAG (semantic search)</label>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Chat</h5>
            <div id="chatWindow" class="chat-window">
              <div class="empty-state">Start a conversation by typing a message below</div>
            </div>
            <div class="mt-3">
              <textarea id="userPrompt" class="form-control" rows="3" placeholder="Ask a question about your codebase..."></textarea>
              <div class="controls-area mt-2">
                <button id="sendBtn" class="btn btn-primary">Send</button>
                <button id="clearBtn" class="btn btn-outline-secondary">Clear History</button>
                <div id="loadingIndicator" style="display:none;" class="spinner-small"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const chatWindow = document.getElementById("chatWindow");
    const userPrompt = document.getElementById("userPrompt");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const loadingIndicator = document.getElementById("loadingIndicator");
    
    let chatHistory = JSON.parse(localStorage.getItem("picocode_chat_history") || "[]");

    function renderChat() {
      if (chatHistory.length === 0) {
        chatWindow.innerHTML = '<div class="empty-state">Start a conversation by typing a message below</div>';
        return;
      }
      
      chatWindow.innerHTML = "";
      chatHistory.forEach((msg, idx) => {
        const msgDiv = document.createElement("div");
        msgDiv.className = `msg ${msg.role}`;
        
        let content = `
          <div class="card">
            <div class="card-body">
              <div>${escapeHtml(msg.text)}</div>
        `;
        
        if (msg.context && msg.context.length > 0) {
          content += '<div class="context-list mt-2"><strong>Context:</strong><ul class="mb-0">';
          msg.context.forEach(c => {
            content += `<li>${escapeHtml(c.path)} (${c.score.toFixed(4)})</li>`;
          });
          content += '</ul></div>';
        }
        
        content += `
              <div class="meta mt-2">${msg.timestamp}</div>
            </div>
          </div>
        `;
        
        msgDiv.innerHTML = content;
        chatWindow.appendChild(msgDiv);
      });
      
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function addMessage(role, text, context = []) {
      const timestamp = new Date().toLocaleTimeString();
      chatHistory.push({ role, text, context, timestamp });
      localStorage.setItem("picocode_chat_history", JSON.stringify(chatHistory));
      renderChat();
    }

    async function sendMessage() {
      const prompt = userPrompt.value.trim();
      if (!prompt) return;
      
      const project_id = document.getElementById("project_id").value;
      if (!project_id) {
        alert("Please select a project or index one first.");
        return;
      }
      
      const use_rag = document.getElementById("use_rag").checked;
      const top_k = parseInt(document.getElementById("top_k").value) || 5;
      
      addMessage("user", prompt);
      userPrompt.value = "";
      
      sendBtn.disabled = true;
      loadingIndicator.style.display = "block";
      
      try {
        const response = await fetch("/code", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            prompt, 
            use_rag, 
            project_id,
            top_k 
          })
        });
        
        const data = await response.json();
        
        if (data.error) {
          addMessage("assistant", `Error: ${data.error}`);
        } else {
          addMessage("assistant", data.response, data.used_context || []);
        }
      } catch (err) {
        addMessage("assistant", `Error: ${err.message}`);
      } finally {
        sendBtn.disabled = false;
        loadingIndicator.style.display = "none";
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    userPrompt.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        sendMessage();
      }
    });

    clearBtn.addEventListener("click", () => {
      if (confirm("Clear chat history?")) {
        chatHistory = [];
        localStorage.removeItem("picocode_chat_history");
        renderChat();
      }
    });

    // Highlight selected project
    document.querySelectorAll(".project-item").forEach(li => {
      li.addEventListener("click", () => {
        document.querySelectorAll(".project-item").forEach(item => item.classList.remove("active"));
        li.classList.add("active");
        const pid = li.getAttribute("data-project-id");
        document.getElementById("project_id").value = pid;
      });
    });

    // Select first project by default
    const firstProject = document.querySelector(".project-item");
    if (firstProject) {
      firstProject.classList.add("active");
    }

    // Poll for project status updates with detailed stats
    setInterval(async () => {
      try {
        const response = await fetch("/projects/status");
        const projects = await response.json();
        
        // Update project status badges and stats
        for (const p of projects) {
          const item = document.querySelector(`[data-project-id="${p.id}"]`);
          if (item) {
            const badge = item.querySelector('.badge');
            if (badge) {
              badge.className = `badge bg-${p.status === 'ready' ? 'success' : p.status === 'indexing' ? 'warning' : 'secondary'}`;
              badge.textContent = p.status;
            }
            
            // Fetch detailed stats for this project
            try {
              const detailResponse = await fetch(`/api/projects/${p.id}`);
              const details = await detailResponse.json();
              
              if (details.indexing_stats) {
                const indexingInfo = item.querySelector('.indexing-info');
                const fileCount = item.querySelector('.file-count');
                const embeddingCount = item.querySelector('.embedding-count');
                
                if (indexingInfo && fileCount && embeddingCount) {
                  fileCount.textContent = details.indexing_stats.file_count || 0;
                  embeddingCount.textContent = details.indexing_stats.embedding_count || 0;
                  
                  // Show stats if project has been indexed
                  if (details.indexing_stats.file_count > 0) {
                    indexingInfo.style.display = 'block';
                  } else {
                    indexingInfo.style.display = 'none';
                  }
                }
              }
            } catch (detailErr) {
              // Ignore errors fetching individual project details
            }
          }
        }
      } catch (err) {
        console.error("Error polling status:", err);
      }
    }, 3000);

    // Initial render
    renderChat();
  </script>
</body>
</html>
