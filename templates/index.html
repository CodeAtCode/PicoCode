<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PicoCode - Local Codebase Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 1.5rem; padding-bottom: 3rem; background:#f7f9fb; }
    .chat-window { height: 62vh; overflow:auto; padding:.75rem; background:#ffffff; border:1px solid #e9ecef; border-radius:8px; }
    .msg { margin-bottom:.75rem; display:flex; gap:.75rem; }
    .msg.user { justify-content:flex-end; }
    .msg.assistant { justify-content:flex-start; }
    .msg .card { max-width:78%; border-radius:10px; box-shadow:none; }
    .msg.user .card { background:#e9f5ff; border:1px solid #cfeeff; }
    .msg.assistant .card { background:#f8f9fa; border:1px solid #e9ecef; }
    .meta { font-size:.80rem; color:#6c757d; }
    .actions { display:flex; gap:.25rem; align-items:center; }
    .spinner-small { width:1rem; height:1rem; border:2px solid rgba(0,0,0,0.12); border-top-color:#0d6efd; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .context-list { font-family:monospace; font-size:.85rem; color:#333; }
    .controls-area { display:flex; gap:.5rem; align-items:center; }
    .empty-state { height:62vh; display:flex; align-items:center; justify-content:center; color:#6c757d; }
    .btn-sm-icon { padding:.25rem .5rem; font-size:.85rem; }
  </style>
</head>
<body>
  <div class="container">
    <header class="mb-4">
      <h1 class="h3">PicoCode —  Local Codebase Assistant</h1>
      <p class="text-muted small">Interact with the codebase assistant, keep chat history in your browser, delete or regenerate assistant replies.</p>
    </header>

    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Server / Configuration</h5>
            <p class="mb-1"><strong>Host:</strong> {{ config.get("uvicorn_host", "127.0.0.1") }} &nbsp; <strong>Port:</strong> {{ config.get("uvicorn_port", 8000) }}</p>
            <p class="mb-1"><strong>Local path:</strong> {{ config.get("local_path") or "not set" }}</p>
            <p class="mb-1"><strong>Venv path:</strong> {{ config.get("venv_path") or "not set" }}</p>
            <p class="mb-1"><strong>Embedding model:</strong> {{ config.get("embedding_model") or "not set" }}</p>
            <p class="mb-0"><strong>Coding model:</strong> {{ config.get("coding_model") or "not set" }}</p>

            <form action="/analyze" method="post" class="mt-3">
              <button class="btn btn-primary w-100" type="submit">Analyze configured local path (background)</button>
            </form>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-body">
            <h5 class="card-title">Analyses</h5>
            {% if analyses %}
              <ul class="list-group list-group-flush">
                {% for a in analyses %}
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="ms-2 me-auto">
                      <div class="fw-bold">{{ a.name }} — ID: {{ a.id }}</div>
                      <div class="small text-muted">{{ a.path }} — <em>{{ a.created_at }}</em></div>
                      <div class="small mt-1">
                        {% if a.status == 'running' %}
                          <span class="badge bg-warning text-dark">running</span>
                        {% elif a.status == 'completed' %}
                          <span class="badge bg-success">completed</span>
                          <span class="text-muted ms-2">files: {{ a.file_count }}, embeddings: {{ a.embedding_count }}</span>
                        {% elif a.status == 'failed' %}
                          <span class="badge bg-danger">failed</span>
                        {% else %}
                          <span class="badge bg-secondary">{{ a.status }}</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="d-flex flex-column align-items-end">
                      <form action="/analysis/{{ a.id }}/delete" method="post" onsubmit="return confirmDelete(this, '{{ a.name|e }}');">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                      </form>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="mb-0 text-muted">No analyses yet.</p>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card">
          <div class="card-body d-flex flex-column" style="min-height:64vh;">
            <div class="d-flex mb-3 align-items-center">
              <h5 class="card-title mb-0">Chat</h5>
              <div class="ms-auto d-flex align-items-center">
                <label class="small mb-0 me-2">Analysis ID</label>
                <input type="number" id="analysis_id" class="form-control form-control-sm" value="{{ analyses[0].id if analyses else '' }}" style="width:8rem;">
              </div>
            </div>

            <div id="chatWindow" class="chat-window mb-3" aria-live="polite"></div>

            <div class="mt-auto">
              <div class="mb-2 d-flex gap-2">
                <div class="form-check form-switch me-3">
                  <input class="form-check-input" type="checkbox" id="use_rag" checked>
                  <label class="form-check-label" for="use_rag">Include retrieved context (RAG)</label>
                </div>

                <div class="controls-area">
                  <label class="small mb-0 me-1">Top k</label>
                  <input type="number" id="top_k" class="form-control form-control-sm" value="5" min="1" max="50" style="width:5rem;">
                </div>

                <div class="ms-auto d-flex gap-2">
                  <button id="clearBtn" class="btn btn-outline-secondary btn-sm">Clear History</button>
                </div>
              </div>

              <div class="d-flex gap-2">
                <textarea id="chatInput" class="form-control" rows="3" placeholder="Type your question. Enter to send, Shift+Enter for newline."></textarea>
                <div class="d-flex flex-column align-items-end" style="width:12rem;">
                  <button id="sendBtn" class="btn btn-primary mb-2 w-100">Send</button>
                  <button id="searchBtn" class="btn btn-outline-primary w-100">Search Only</button>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <script>
    const STORAGE_KEY = "picochat_history_v1";
    function nowISO(){ return new Date().toISOString(); }
    function uid(){ return Math.random().toString(36).slice(2,11); }

    function loadHistory(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch(e){
        return [];
      }
    }

    function saveHistory(arr){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      } catch(e){}
    }

    function renderMarkdown(md){
      try{
        const html = marked.parse(md || "");
        return DOMPurify.sanitize(html);
      } catch(e){
        return DOMPurify.sanitize(String(md || ""));
      }
    }

    function createMessageCard(msg){
      const wrapper = document.createElement("div");
      wrapper.className = `msg ${msg.role}`;
      const card = document.createElement("div");
      card.className = "card p-2";
      const body = document.createElement("div");
      body.className = "card-body p-2";
      const meta = document.createElement("div");
      meta.className = "meta mb-1 d-flex justify-content-between align-items-center";

      const leftMeta = document.createElement("div");
      leftMeta.textContent = msg.role === "user" ? "You" : "Assistant";
      const rightMeta = document.createElement("div");
      rightMeta.className = "d-flex align-items-center gap-2";

      const time = document.createElement("small");
      time.className = "text-muted";
      time.textContent = new Date(msg.created_at).toLocaleString();
      rightMeta.appendChild(time);

      if(msg.role === "assistant"){
        if(msg.status === "pending"){
          const spinner = document.createElement("div");
          spinner.className = "spinner-small ms-2";
          rightMeta.appendChild(spinner);
        } else if(msg.status === "deleted"){
          const delTag = document.createElement("span");
          delTag.className = "text-muted small ms-2";
          delTag.textContent = "deleted";
          rightMeta.appendChild(delTag);
        } else if(msg.status === "error"){
          const err = document.createElement("span");
          err.className = "text-danger small ms-2";
          err.textContent = "error";
          rightMeta.appendChild(err);
        }
        const actions = document.createElement("div");
        actions.className = "actions ms-2";
        const regenBtn = document.createElement("button");
        regenBtn.className = "btn btn-outline-secondary btn-sm btn-sm-icon";
        regenBtn.title = "Regenerate";
        regenBtn.textContent = "Regenerate";
        regenBtn.addEventListener("click", ()=>regenerateMessage(msg.id));

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-outline-danger btn-sm btn-sm-icon";
        delBtn.title = msg.status === "deleted" ? "Remove permanently" : "Delete";
        delBtn.textContent = msg.status === "deleted" ? "Remove" : "Delete";
        // soft-delete versus permanent removal
        if(msg.status === "deleted"){
          delBtn.addEventListener("click", ()=>permanentDeleteMessage(msg.id));
        } else {
          delBtn.addEventListener("click", ()=>softDeleteMessage(msg.id));
        }
        actions.appendChild(regenBtn);
        actions.appendChild(delBtn);
        rightMeta.appendChild(actions);
      }

      meta.appendChild(leftMeta);
      meta.appendChild(rightMeta);

      const content = document.createElement("div");
      content.className = "content";
      if(msg.role === "assistant"){
        if(msg.status === "deleted"){
          content.textContent = "(deleted)";
          content.className = "content text-muted fst-italic";
        } else {
          const md = typeof msg.text === "string" ? msg.text : JSON.stringify(msg.text, null, 2);
          content.innerHTML = renderMarkdown(md);
        }
      } else {
        content.textContent = msg.text || "";
      }

      body.appendChild(meta);
      body.appendChild(content);

      if(msg.used_context && Array.isArray(msg.used_context) && msg.used_context.length){
        const ctxHeader = document.createElement("div");
        ctxHeader.className = "muted-small mt-2";
        ctxHeader.textContent = "Sources:";
        const ctxList = document.createElement("ul");
        ctxList.className = "list-group list-group-flush mt-1 context-list";
        msg.used_context.forEach(s=>{
          const li = document.createElement("li");
          li.className = "list-group-item";
          li.style.border="none";
          li.textContent = `${s.path} (score: ${s.score !== undefined && s.score !== null ? parseFloat(s.score).toFixed(4) : "n/a"})`;
          ctxList.appendChild(li);
        });
        body.appendChild(ctxHeader);
        body.appendChild(ctxList);
      }

      card.appendChild(body);
      wrapper.appendChild(card);
      wrapper.dataset.msgId = msg.id;
      return wrapper;
    }

    function renderChat(){
      const win = document.getElementById("chatWindow");
      win.innerHTML = "";
      const msgs = loadHistory();
      if(!msgs.length){
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "No messages yet. Ask a question to start.";
        win.appendChild(empty);
        return;
      }
      msgs.forEach(m=>{
        const el = createMessageCard(m);
        win.appendChild(el);
      });
      win.scrollTop = win.scrollHeight;
    }

    function appendAndSave(msg){
      const arr = loadHistory();
      arr.push(msg);
      saveHistory(arr);
      renderChat();
    }

    function updateMessage(id, patch){
      const arr = loadHistory();
      const idx = arr.findIndex(x=>x.id===id);
      if(idx===-1) return;
      arr[idx] = Object.assign({}, arr[idx], patch);
      saveHistory(arr);
      renderChat();
    }

    async function sendMessage(){
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
      if(!text) return;
      input.value = "";
      const userMsg = { id: uid(), role: "user", text: text, created_at: nowISO() };
      appendAndSave(userMsg);
      const assistantId = uid();
      const assistantMsg = { id: assistantId, role: "assistant", text: "", created_at: nowISO(), status: "pending", replyTo: userMsg.id, used_context: [] };
      appendAndSave(assistantMsg);
      await callModel(userMsg, assistantId);
    }

    async function callModel(userMsg, assistantId){
      const aid = parseInt(document.getElementById("analysis_id").value || 0) || null;
      const use_rag = document.getElementById("use_rag").checked;
      const top_k = parseInt(document.getElementById("top_k").value || 5);
      updateMessage(assistantId, { status: "pending", text: "" });
      try{
        const resp = await fetch("/code", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ prompt: userMsg.text, context: "", use_rag: use_rag, analysis_id: aid, top_k: top_k })
        });
        if(!resp.ok){
          const txt = await resp.text();
          updateMessage(assistantId, { status: "error", text: `Request failed: ${resp.status} ${resp.statusText}\n\n${txt}` });
          return;
        }
        const data = await resp.json();
        const md = typeof data.response === "string" ? data.response : JSON.stringify(data.response, null, 2);
        updateMessage(assistantId, { status: "done", text: md, used_context: data.used_context || [] });
      } catch(e){
        updateMessage(assistantId, { status: "error", text: String(e) });
      }
    }

    async function regenerateMessage(assistantId){
      const arr = loadHistory();
      const msg = arr.find(m=>m.id===assistantId);
      if(!msg) return;
      const userMsg = arr.find(m=>m.id===msg.replyTo);
      if(!userMsg) return;
      // mark pending and clear previous used_context
      updateMessage(assistantId, { status: "pending", text: "", used_context: [] });
      await callModel(userMsg, assistantId);
    }

    // Soft-delete: keep message so regeneration can still find replyTo and id.
    function softDeleteMessage(assistantId){
      updateMessage(assistantId, { status: "deleted", text: "", used_context: [] });
    }

    // Permanent removal from history
    function permanentDeleteMessage(assistantId){
      const arr = loadHistory().filter(m=>m.id!==assistantId);
      saveHistory(arr);
      renderChat();
    }

    // Backwards compatibility: keep function name if something else calls deleteMessage
    function deleteMessage(assistantId){
      // default to soft-delete to preserve regenerate behavior
      softDeleteMessage(assistantId);
    }

    function clearHistory(){
      if(!confirm("Clear entire chat history?")) return;
      localStorage.removeItem(STORAGE_KEY);
      renderChat();
    }

    async function searchOnly(){
      const text = document.getElementById("chatInput").value.trim();
      if(!text) return;
      const aid = parseInt(document.getElementById("analysis_id").value || 0) || 0;
      const top_k = parseInt(document.getElementById("top_k").value || 5);
      try{
        const win = document.getElementById("chatWindow");
        // clear previous transient search results (keep history preserved)
        const header = document.createElement("div");
        header.className = "mb-2 muted-small";
        header.textContent = "Search results";
        win.appendChild(header);
        const resp = await fetch("/search", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ query: text, analysis_id: aid, top_k: top_k })
        });
        if(!resp.ok){
          const txt = await resp.text();
          const err = document.createElement("div");
          err.className = "alert alert-danger";
          err.textContent = `Search failed: ${resp.status} ${resp.statusText}\n${txt}`;
          win.appendChild(err);
          win.scrollTop = win.scrollHeight;
          return;
        }
        const data = await resp.json();
        if(Array.isArray(data) && data.length){
          data.forEach(d=>{
            const item = document.createElement("div");
            item.className = "card mb-2 p-2";
            item.innerHTML = `<div class="small"><strong>${DOMPurify.sanitize(d.path)}</strong></div><div class="muted-small">score: ${d.score !== undefined && d.score !== null ? parseFloat(d.score).toFixed(4) : "n/a"}</div>`;
            win.appendChild(item);
          });
        } else {
          const nodata = document.createElement("div");
          nodata.className = "text-muted small";
          nodata.textContent = "No results";
          win.appendChild(nodata);
        }
        win.scrollTop = win.scrollHeight;
      } catch(e){
        const win = document.getElementById("chatWindow");
        const err = document.createElement("div");
        err.className = "alert alert-danger";
        err.textContent = String(e);
        win.appendChild(err);
        win.scrollTop = win.scrollHeight;
      }
    }

    document.getElementById("sendBtn").addEventListener("click", sendMessage);
    document.getElementById("clearBtn").addEventListener("click", clearHistory);
    document.getElementById("searchBtn").addEventListener("click", searchOnly);
    document.getElementById("chatInput").addEventListener("keydown", function(e){
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });

    renderChat();
  </script>
</body>
</html>
